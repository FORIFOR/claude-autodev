#!/usr/bin/env bash

# LINEé€šçŸ¥é€ä¿¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

if [ $# -lt 1 ]; then
    echo "Usage: $0 <project_name>"
    exit 1
fi

PROJECT_NAME=$1
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BASE_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_DIR="$BASE_DIR/deliverables/$PROJECT_NAME"
REPORTS_DIR="$BASE_DIR/logs/reports"

# LINE Botè¨­å®š
CHANNEL_ACCESS_TOKEN="FzpiO7StfY1GtQ1URU5um4IiwXipxgM+bZeuMd1h2b947eoy4doDrd96Sw9x8VKix/aYs4T3zkNL/vZRHo20bF28t35D1urum/WptrpnEthFZUFAR3NpBxc0kQ6U9Q2wXZ6422tOx/5nRCkn5qtsIAdB04t89/1O/w1cDnyilFU"
DESTINATION_USER_ID="U2f0d021267564d91134b178d7f65fc84"

# ç›´æ¥LINE APIå‘¼ã³å‡ºã—é–¢æ•°
send_direct_line_message() {
    local msg="$1"
    
    # JSON ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    escaped_msg=$(echo "$msg" | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n' | sed 's/\\n$//')
    
    curl -X POST https://api.line.me/v2/bot/message/push \
        -H "Authorization: Bearer $CHANNEL_ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
            \"to\": \"$DESTINATION_USER_ID\",
            \"messages\": [{
                \"type\": \"text\",
                \"text\": \"$escaped_msg\"
            }]
        }" \
        -s -o /dev/null
    
    if [ $? -eq 0 ]; then
        echo "âœ… LINE notification sent successfully via direct API"
    else
        echo "âŒ Failed to send LINE notification"
    fi
}

echo "ğŸ“± Sending LINE notification for: $PROJECT_NAME"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’åé›†
completion_time=$(date '+%Y/%m/%d %H:%M')
file_count=$(find "$PROJECT_DIR" -type f 2>/dev/null | wc -l | tr -d ' ')
has_readme=$([ -f "$PROJECT_DIR/README.md" ] && echo "âœ…" || echo "âŒ")
has_tests=$([ -d "$PROJECT_DIR/tests" ] && echo "âœ…" || echo "âŒ")

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
message="ğŸ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†é€šçŸ¥

ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT_NAME
â° å®Œäº†æ™‚åˆ»: $completion_time
ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«æ•°: $file_count
ğŸ“– README: $has_readme
ğŸ§ª ãƒ†ã‚¹ãƒˆ: $has_tests

ğŸ”— ãƒ‘ã‚¹: deliverables/$PROJECT_NAME/

Generated by Claude Autodev ğŸ¤–"

# Claude Code ã® MCP ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦LINEé€šçŸ¥ã‚’é€ä¿¡
echo "Attempting to send notification via Claude Code MCP..."

# ä¸€æ™‚çš„ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
temp_json=$(mktemp)
cat > "$temp_json" << EOF
{
  "message": "$message",
  "userId": "$DESTINATION_USER_ID"
}
EOF

# Claude CodeçµŒç”±ã§é€ä¿¡ã‚’è©¦è¡Œ
if command -v claude >/dev/null 2>&1; then
    echo "ğŸ“¤ Sending via Claude Code MCP..."
    claude --prompt "Use the LINE MCP server to send the following message to user $DESTINATION_USER_ID: $message" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "âœ… LINE notification sent successfully via Claude Code MCP"
    else
        echo "âš ï¸  Claude Code MCP method failed, trying direct API..."
        # ç›´æ¥APIå‘¼ã³å‡ºã—ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        send_direct_line_message "$message"
    fi
else
    echo "âš ï¸  Claude CLI not found, trying direct API..."
    send_direct_line_message "$message"
fi

# é€šçŸ¥ãƒ­ã‚°ã«è¨˜éŒ²
echo "$(date): Sent notification for $PROJECT_NAME" >> "$BASE_DIR/logs/notifications.log"

rm -f "$temp_json"