#!/usr/bin/env bash

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

if [ $# -lt 1 ]; then
    echo "Usage: $0 <project_name>"
    exit 1
fi

PROJECT_NAME=$1
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BASE_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_DIR="$BASE_DIR/deliverables/$PROJECT_NAME"
REPORTS_DIR="$BASE_DIR/logs/reports"

mkdir -p "$REPORTS_DIR"

if [ ! -d "$PROJECT_DIR" ]; then
    echo "Error: Project directory '$PROJECT_DIR' does not exist"
    exit 1
fi

REPORT_FILE="$REPORTS_DIR/${PROJECT_NAME}_completion_report.md"

echo "ğŸ“Š Generating completion report for: $PROJECT_NAME"

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
cat > "$REPORT_FILE" << EOF
# ğŸ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: $PROJECT_NAME
- **å®Œäº†æ—¥æ™‚**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
- **æˆæœç‰©ãƒ‘ã‚¹**: \`deliverables/$PROJECT_NAME/\`

## ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
EOF

# ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¿½åŠ 
echo "" >> "$REPORT_FILE"
echo "\`\`\`" >> "$REPORT_FILE"
cd "$PROJECT_DIR"
find . -type f -name "*.md" -o -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.json" -o -name "*.yaml" -o -name "*.yml" | sort >> "$REPORT_FILE"
echo "\`\`\`" >> "$REPORT_FILE"

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’è¿½åŠ 
echo "" >> "$REPORT_FILE"
echo "## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ " >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"
echo "\`\`\`" >> "$REPORT_FILE"
tree -I 'node_modules|.git|__pycache__|.next|dist|build' -L 3 2>/dev/null || find . -type d | head -20 | sort >> "$REPORT_FILE"
echo "\`\`\`" >> "$REPORT_FILE"

# READMEã®å†…å®¹ã‚’å–å¾—
if [ -f "README.md" ]; then
    echo "" >> "$REPORT_FILE"
    echo "## ğŸ“– ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    head -20 "README.md" >> "$REPORT_FILE"
fi

# RELEASE.mdã®å†…å®¹ã‚’å–å¾—
if [ -f "RELEASE.md" ]; then
    echo "" >> "$REPORT_FILE"
    echo "## ğŸš€ ãƒªãƒªãƒ¼ã‚¹æƒ…å ±" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    head -20 "RELEASE.md" >> "$REPORT_FILE"
fi

# Gitçµ±è¨ˆ
if [ -d ".git" ]; then
    echo "" >> "$REPORT_FILE"
    echo "## ğŸ“ˆ é–‹ç™ºçµ±è¨ˆ" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "- **ç·ã‚³ãƒŸãƒƒãƒˆæ•°**: $(git rev-list --count HEAD 2>/dev/null || echo 'N/A')" >> "$REPORT_FILE"
    echo "- **ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $(find . -type f | wc -l | tr -d ' ')" >> "$REPORT_FILE"
    echo "- **ã‚³ãƒ¼ãƒ‰è¡Œæ•°**: $(find . -name "*.py" -o -name "*.js" -o -name "*.ts" | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}' || echo 'N/A')" >> "$REPORT_FILE"
fi

echo "" >> "$REPORT_FILE"
echo "---" >> "$REPORT_FILE"
echo "*Generated by Claude Autodev Master Monitor*" >> "$REPORT_FILE"

echo "âœ… Report generated: $REPORT_FILE"
echo "ğŸ“„ Report summary:"
echo "   - Files: $(find "$PROJECT_DIR" -type f | wc -l | tr -d ' ')"
echo "   - Directories: $(find "$PROJECT_DIR" -type d | wc -l | tr -d ' ')"