#!/usr/bin/env bash

# LINEé€šçŸ¥é€ä¿¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

if [ $# -lt 1 ]; then
    echo "Usage: $0 <project_name>"
    exit 1
fi

PROJECT_NAME=$1
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BASE_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_DIR="$BASE_DIR/deliverables/$PROJECT_NAME"
REPORTS_DIR="$BASE_DIR/logs/reports"

# LINE Botè¨­å®š
CHANNEL_ACCESS_TOKEN="FzpiO7StfY1GtQ1URU5um4IiwXipxgM+bZeuMd1h2b947eoy4doDrd96Sw9x8VKix/aYs4T3zkNL/vZRHo20bF28t35D1urum/WptrpnEthFZUFAR3NpBxc0kQ6U9Q2wXZ6422tOx/5nRCkn5qtsIAdB04t89/1O/w1cDnyilFU"
DESTINATION_USER_ID="U2f0d021267564d91134b178d7f65fc84"

# ç›´æ¥LINE APIå‘¼ã³å‡ºã—é–¢æ•°
send_direct_line_message() {
    local msg="$1"
    
    # JSON ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    escaped_msg=$(echo "$msg" | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n' | sed 's/\\n$//')
    
    curl -X POST https://api.line.me/v2/bot/message/push \
        -H "Authorization: Bearer $CHANNEL_ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
            \"to\": \"$DESTINATION_USER_ID\",
            \"messages\": [{
                \"type\": \"text\",
                \"text\": \"$escaped_msg\"
            }]
        }" \
        -s -o /dev/null
    
    if [ $? -eq 0 ]; then
        echo "âœ… LINE notification sent successfully via direct API"
    else
        echo "âŒ Failed to send LINE notification"
    fi
}

echo "ğŸ“± Sending LINE notification for: $PROJECT_NAME"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’åé›†
completion_time=$(date '+%Y/%m/%d %H:%M')
file_count=$(find "$PROJECT_DIR" -type f 2>/dev/null | wc -l | tr -d ' ')
has_readme=$([ -f "$PROJECT_DIR/README.md" ] && echo "âœ…" || echo "âŒ")
has_tests=$([ -d "$PROJECT_DIR/tests" ] && echo "âœ…" || echo "âŒ")

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
message="ğŸ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†é€šçŸ¥

ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT_NAME
â° å®Œäº†æ™‚åˆ»: $completion_time
ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«æ•°: $file_count
ğŸ“– README: $has_readme
ğŸ§ª ãƒ†ã‚¹ãƒˆ: $has_tests

ğŸ”— ãƒ‘ã‚¹: deliverables/$PROJECT_NAME/

Generated by Claude Autodev ğŸ¤–"

# Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆçµŒç”±ã§LINEé€šçŸ¥ã‚’é€ä¿¡
echo "ğŸ“¤ Sending via Python LINE Messaging API script..."

# ã‚µãƒãƒªãƒ¼æƒ…å ±ã‚’ä½œæˆ
summary="ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $file_count | ğŸ“– README: $has_readme | ğŸ§ª ãƒ†ã‚¹ãƒˆ: $has_tests"

if python3 "$SCRIPT_DIR/send_line_message.py" "$PROJECT_NAME" "$summary"; then
    echo "âœ… LINE notification sent successfully via Python script"
else
    echo "âš ï¸  LINE API failed, sending local notification..."
    # ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    "$SCRIPT_DIR/send_local_notification.sh" "$PROJECT_NAME" "$summary"
    
    # æœ€å¾Œã®æ‰‹æ®µã¨ã—ã¦ç›´æ¥APIè©¦è¡Œ
    echo "Also trying direct API call..."
    send_direct_line_message "$message"
fi

# Slacké€šçŸ¥ã‚‚é€ä¿¡
echo "ğŸ“¤ Sending Slack notification..."
if python3 "$SCRIPT_DIR/send_slack_message.py" "$PROJECT_NAME" "$summary"; then
    echo "âœ… Slack notification sent successfully"
else
    echo "âš ï¸  Slack notification failed (webhook not configured or error)"
fi

# å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ã‚‚é€ä¿¡ï¼ˆé‡è¦ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ã‚’è¦‹é€ƒã•ãªã„ãŸã‚ï¼‰
"$SCRIPT_DIR/send_local_notification.sh" "$PROJECT_NAME" "$summary"

# é€šçŸ¥ãƒ­ã‚°ã«è¨˜éŒ²
echo "$(date): Sent notification for $PROJECT_NAME" >> "$BASE_DIR/logs/notifications.log"

rm -f "$temp_json"